// GigaScroll
// version: 0.1.1
// author: Mattias Petter Johansson <mpj@mpj.me> http://mpj.me
// license: MIT
'use strict';function createNativeStringTemplateEngine(){var l=function(j){var d={},b=j;this.data=function(a,b){if(!b)return d[a];d[a]=b};this.text=function(a){if(!a)return b;b=a}},e={},b=new ko.nativeTemplateEngine;b.makeTemplateSource=function(b){return e[b]};b.addTemplate=function(b,d){e[b]=new l(d)};return b};(function(){ko.bindingHandlers.gigaScroll={init:function(l,e){var b=ko.utils.unwrapObservable(e()),j,d=l.innerHTML,h=createNativeStringTemplateEngine(),a="gigaScrollViewport"+Math.floor(1E6*Math.random()+1).toString(),i="gigaScrollList"+Math.floor(1E6*Math.random()+1).toString();h.addTemplate("gigaScroll",'    <div id="'+a+'" style="width: 100%; height: 100%; overflow-y: scroll">      <div data-bind="style: { height: riverHeight() + \'px\' }">        <div data-bind="style: { paddingTop: raftOffsetTop() + \'px\' }">          <ul id="'+
i+'" data-bind="foreach: visibleItems">            '+d+"          </ul>        </div>      </div>    </div>");ko.renderTemplate("gigaScroll",b,{templateEngine:h},l,"replaceNode");d=document.getElementById(i);h=l.attributes;for(i=0;i<h.length;i++){var f=h[i];"data-bind"!==f.name&&d.setAttribute(f.name,f.value)}j=document.getElementById(a);b.setActive(!1);b.sample(7);var m=!1;b.visibleItems.subscribe(function(a){if(a[a.length-1]&&!m){m=!0;var d,h=function(){for(var c,a=!1,b=e.peek(),d=f.getElementsByTagName("li"),
g=0;g<d.length;g++)c=d[g].offsetTop,b[g]!==c&&(b[g]=c,a=!0);a&&e.valueHasMutated()},a=function(){clearTimeout(i);i=setTimeout(h,16)},f=j.getElementsByTagName("UL")[0],i,e;e=ko.observableArray();f.addEventListener("DOMNodeInserted",a,!1);window.addEventListener("resize",a,!1);window.addEventListener("scroll",a,!1);a();d=e;j.addEventListener("scroll",function(){b.setScrollPosition(j.scrollTop)});a=function(){b.setViewPortHeight(j.offsetHeight)};window.addEventListener("resize",a,!1);a();var c=ko.computed({read:function(){var c=
[],a;for(a in g())c.push(parseInt(a));return c},deferEvaluation:!0}),g=ko.computed({read:function(){var c,a={};d().forEach(function(b){c=b.toString();a[c]=a[c]?a[c]+1:1});return 1===a.length?{}:a},deferEvaluation:!0});ko.computed(function(){var a=c();0!==a.length&&(a.sort(function(c,a){return c-a}),b.setRowHeight(a[1]-a[0]))});ko.computed(function(){var a,d;0!==g().length&&(c().forEach(function(c){d=g()[c.toString()];if(!a||d>a)a=d}),b.setRowLength(a))})}});return{controlsDescendantBindings:!0}}}})();function GigaScrollViewModel(l){function e(a){return ko.computed({read:a,deferEvaluation:!0}).extend({notifyComparer:b})}function b(a,b){return a===b}this.sample=function(a){k(a)};this.setActive=function(a){r(a)};this.visibleItems=e(function(){var c,b;if(0===d()||null===j())return[];c=j()-d();c=Math.max(c,0);b=3*d();a:{for(var e=c,f=b;!p()&&h()[e];)e++,f--;for(;!p()&&h()[e+f-1]||null!==a()&&a()<=e+f-1;)if(1>f--)break a;clearTimeout(s);s=setTimeout(function(){l.load(e,f,function(c,b){var d=h.peek();
p()&&(d.length=0);for(var g=0;g<f;g++)d[e+g]=c[g];a(b);p(!1);h.valueHasMutated()})},250)}b=Array(d());for(c=0;c<d();c++)b[c]=h()[j()+c];return b});this.raftOffsetTop=e(function(){return Math.floor(j()/n())*f()});this.riverHeight=e(function(){return Math.floor(a()/n())*f()});this.setViewPortHeight=function(a){if(!k())throw Error("Call sample and then render and measure the resulting visibleItems before calling setViewPortHeight.");i(a)};this.setRowHeight=function(a){if(!k())throw Error("Call sample and then render and measure the resulting visibleItems before calling setRowHeight.");
clearTimeout(q);q=setTimeout(function(){f(a)},16)};this.setRowLength=function(a){if(!k())throw Error("Call sample and then render and measure the resulting visibleItems before calling setRowLength.");n(a)};this.setScrollPosition=function(a){m(a)};this.invalidateCache=function(){p(!0)};var j=e(function(){if(null===f())return k()?0:null;var c=Math.floor(m()/f()),b=a()-d(),c=c*n();return Math.min(b,c)}),d=e(function(){if(!r())return 0;if(null===i()||null===f())return k()?a()&&a()<k()?a():k():0;var b=
Math.ceil(i()/f())*n();return null!==a()&&a()<b?a():b});ko.extenders.notifyComparer=function(a,b){var d=ko.observable();d.equalityComparer=function(a,c){if(Array.isArray(a)){if(Array.isArray(c)){if(a.length!==c.length)return!1;for(var d=0;d<a.length;d++)if(!b(a[d],c[d]))return!1;return!0}return!1}return b(a,c)};a.subscribe(d);var e=!0;return ko.computed({deferEvaluation:!0,read:function(){e&&(e=!1,d(a.peek()));return d()}})};var h=ko.observableArray(),a=ko.observable(null),i=ko.observable(null),f=
ko.observable(null),m=ko.observable(0),n=ko.observable(1),k=ko.observable(null),r=ko.observable(!0),p=ko.observable(!1),s=null,q=null};
