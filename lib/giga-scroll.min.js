// GigaScroll
// version: 0.1.3
// author: Mattias Petter Johansson <mpj@mpj.me> http://mpj.me
// license: MIT
'use strict';function createNativeStringTemplateEngine(){var h=function(c){var f={},d=c;this.data=function(b,c){if(!c)return f[b];f[b]=c};this.text=function(b){if(!b)return d;d=b}},e={},c=new ko.nativeTemplateEngine;c.makeTemplateSource=function(c){return e[c]};c.addTemplate=function(c,f){e[c]=new h(f)};return c};(function(){ko.bindingHandlers.gigaScroll={init:function(h,e){var c=ko.utils.unwrapObservable(e()),i,f=h.innerHTML,d=createNativeStringTemplateEngine(),b="gigaScrollViewport"+Math.floor(1E6*Math.random()+1).toString(),j="gigaScrollList"+Math.floor(1E6*Math.random()+1).toString();d.addTemplate("gigaScroll",'    <div id="'+b+'" style="width: 100%; height: 100%; overflow-y: scroll; -webkit-transform:translateZ(0)">      <div data-bind="style: { height: riverHeight() + \'px\' }">        <div data-bind="style: { paddingTop: raftOffsetTop() + \'px\' }">          <ul id="'+
j+'" data-bind="foreach: renderItems">            '+f+"          </ul>        </div>      </div>    </div>");ko.renderTemplate("gigaScroll",c,{templateEngine:d},h,"replaceNode");f=document.getElementById(j);d=h.attributes;for(j=0;j<d.length;j++){var g=d[j];"data-bind"!==g.name&&f.setAttribute(g.name,g.value)}i=document.getElementById(b);c.setActive(!1);c.sample(7);var m=!1;c.renderItems.subscribe(function(b){if(b[b.length-1]&&!m){m=!0;var f,d=function(){for(var b,c=!1,f=a.peek(),d=g.getElementsByTagName("li"),
k=0;k<d.length;k++){if(!ko.dataFor(d[k]))return;b=d[k].offsetTop;f[k]!==b&&(f[k]=b,c=!0)}c&&(g.removeEventListener("DOMNodeInserted",e,!1),a.valueHasMutated())},e=function(){clearTimeout(j);j=setTimeout(d,16)},g=i.getElementsByTagName("UL")[0],j,a;a=ko.observableArray();g.addEventListener("DOMNodeInserted",e,!1);window.addEventListener("resize",e,!1);e();f=a;i.addEventListener("scroll",function(){c.setScrollPosition(i.scrollTop)});b=function(){c.setViewPortHeight(i.offsetHeight)};window.addEventListener("resize",
b,!1);b();var k=ko.computed({read:function(){var a=[],b;for(b in h())a.push(parseInt(b));return a},deferEvaluation:!0}),h=ko.computed({read:function(){var a,b={};f().forEach(function(c){a=c.toString();b[a]=b[a]?b[a]+1:1});return 1===b.length?{}:b},deferEvaluation:!0});ko.computed(function(){var a=k();0!==a.length&&(a.sort(function(a,b){return a-b}),c.setRowHeight(a[1]-a[0]))});ko.computed(function(){var a,b;0!==h().length&&(k().forEach(function(c){b=h()[c.toString()];if(!a||b>a)a=b}),c.setRowLength(a))})}});
return{controlsDescendantBindings:!0}}}})();ko.extenders.notifyComparer=function(h,e){var c=ko.observable();c.equalityComparer=function(c,d){if(Array.isArray(c)){if(Array.isArray(d)){if(c.length!==d.length)return!1;for(var b=0;b<c.length;b++)if(!e(c[b],d[b]))return!1;return!0}return!1}return e(c,d)};h.subscribe(c);var i=!0;return ko.computed({deferEvaluation:!0,read:function(){i&&(i=!1,c(h.peek()));return c()}})};
function GigaScrollViewModel(h){function e(a){return ko.computed({read:a,deferEvaluation:!0}).extend({notifyComparer:c})}function c(a,b){return a===b}this.sample=function(a){l(a)};this.setActive=function(a){r(a)};this.renderItems=e(function(){var a,c;if(0===f()||null===i())return[];a=i()-f();a=Math.max(a,0);c=3*f();a:{for(var e=a,g=c;!p()&&d()[e];)e++,g--;for(;!p()&&d()[e+g-1]||null!==b()&&b()<=e+g-1;)if(1>g--)break a;clearTimeout(q);q=setTimeout(function(){h.load(e,g,function(a,c){var f=d.peek();
p()&&(f.length=0);for(var h=0;h<g;h++)f[e+h]=a[h];b(c);p(!1);d.valueHasMutated()})},250)}c=Array(f());for(a=0;a<f();a++)c[a]=d()[i()+a];return c});this.raftOffsetTop=e(function(){return Math.floor(i()/n())*g()});this.riverHeight=e(function(){return Math.floor(b()/n())*g()});this.setViewPortHeight=function(a){if(!l())throw Error("Call sample and then render and measure the resulting renderItems before calling setViewPortHeight.");j(a)};this.setRowHeight=function(a){if(!l())throw Error("Call sample and then render and measure the resulting renderItems before calling setRowHeight.");
clearTimeout(s);s=setTimeout(function(){var b=a-g();1===b||-1===b||g(a)},16)};this.setRowLength=function(a){if(!l())throw Error("Call sample and then render and measure the resulting renderItems before calling setRowLength.");n(a)};this.setScrollPosition=function(a){m(a)};this.invalidateCache=function(){p(!0)};var i=e(function(){if(null===g())return l()?0:null;var a=Math.floor(m()/g()),c=b()-f(),a=a*n();return Math.min(c,a)}),f=e(function(){if(!r())return 0;if(null===j()||null===g())return l()?b()&&
b()<l()?b():l():0;var a=Math.ceil(j()/g())*n();return null!==b()&&b()<a?b():a}),d=ko.observableArray(),b=ko.observable(null),j=ko.observable(null),g=ko.observable(null),m=ko.observable(0),n=ko.observable(1),l=ko.observable(null),r=ko.observable(!0),p=ko.observable(!1),q=null,s=null};
