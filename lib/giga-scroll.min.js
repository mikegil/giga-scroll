// GigaScroll
// version: 0.1.0
// author: Mattias Petter Johansson <mpj@mpj.me> http://mpj.me
// license: MIT
'use strict';function createNativeStringTemplateEngine(){var i=function(h){var d={},c=h;this.data=function(b,c){if(!c)return d[b];d[b]=c};this.text=function(b){if(!b)return c;c=b}},e={},c=new ko.nativeTemplateEngine;c.makeTemplateSource=function(c){return e[c]};c.addTemplate=function(c,d){e[c]=new i(d)};return c};(function(){ko.bindingHandlers.gigaScroll={init:function(i,e){var c=ko.utils.unwrapObservable(e()),h,d=i.innerHTML,f=createNativeStringTemplateEngine();Math.random();Math.random();f.addTemplate("gigaScroll",'    <div id="gigaScrollViewportundefined" style="width: 100%; height: 100%; overflow-y: scroll">      <div data-bind="style: { height: riverHeight() + \'px\' }">        <div data-bind="style: { paddingTop: raftOffsetTop() + \'px\' }">          <ul id="gigaScrollListundefined" data-bind="foreach: visibleItems">            '+
d+"          </ul>        </div>      </div>    </div>");ko.renderTemplate("gigaScroll",c,{templateEngine:f},i,"replaceNode");for(var d=document.getElementById("gigaScrollListundefined"),f=i.attributes,b=0;b<f.length;b++){var g=f[b];"data-bind"!==g.name&&d.setAttribute(g.name,g.value)}h=document.getElementById("gigaScrollViewportundefined");c.setActive(!1);c.sample(7);var j=!1;c.visibleItems.subscribe(function(b){if(b[b.length-1]&&!j){j=!0;var d,f=function(){for(var a,b=!1,c=g.peek(),d=e.getElementsByTagName("li"),
f=0;f<d.length;f++)a=d[f].offsetTop,c[f]!==a&&(c[f]=a,b=!0);b&&g.valueHasMutated()},b=function(){clearTimeout(l);l=setTimeout(f,16)},e=h.getElementsByTagName("UL")[0],l,g;g=ko.observableArray();e.addEventListener("DOMNodeInserted",b,!1);window.addEventListener("resize",b,!1);window.addEventListener("scroll",b,!1);b();d=g;h.addEventListener("scroll",function(){c.setScrollPosition(h.scrollTop)});b=function(){c.setViewPortHeight(h.offsetHeight)};window.addEventListener("resize",b,!1);b();var i=ko.computed({read:function(){var b=
[],c;for(c in a())b.push(parseInt(c));return b},deferEvaluation:!0}),a=ko.computed({read:function(){var a,b={};d().forEach(function(c){a=c.toString();b[a]=b[a]?b[a]+1:1});return 1===b.length?{}:b},deferEvaluation:!0});ko.computed(function(){var a=i();0!==a.length&&(a.sort(function(a,b){return a-b}),c.setRowHeight(a[1]-a[0]))});ko.computed(function(){var b,d;0!==a().length&&(i().forEach(function(c){d=a()[c.toString()];if(!b||d>b)b=d}),c.setRowLength(b))})}});return{controlsDescendantBindings:!0}}}})();function GigaScrollViewModel(i){function e(a){return ko.computed({read:a,deferEvaluation:!0}).extend({notifyComparer:c})}function c(a,b){return a===b}this.sample=function(a){k(a)};this.setActive=function(a){q(a)};this.visibleItems=e(function(){var a,c;if(0===d()||null===h())return[];a=h()-d();a=Math.max(a,0);c=3*d();a:{for(var e=a,g=c;!l()&&f()[e];)e++,g--;for(;!l()&&f()[e+g-1]||null!==b()&&b()<=e+g-1;)if(1>g--)break a;clearTimeout(p);p=setTimeout(function(){i.load(e,g,function(a,c){var d=f.peek();
l()&&(d.length=0);for(var h=0;h<g;h++)d[e+h]=a[h];b(c);l(!1);f.valueHasMutated()})},250)}c=Array(d());for(a=0;a<d();a++)c[a]=f()[h()+a];return c});this.raftOffsetTop=e(function(){return Math.floor(h()/m())*j()});this.riverHeight=e(function(){return Math.floor(b()/m())*j()});this.setViewPortHeight=function(a){if(!k())throw Error("Call sample and then render and measure the resulting visibleItems before calling setViewPortHeight.");g(a)};this.setRowHeight=function(a){if(!k())throw Error("Call sample and then render and measure the resulting visibleItems before calling setRowHeight.");
clearTimeout(r);r=setTimeout(function(){j(a)},16)};this.setRowLength=function(a){if(!k())throw Error("Call sample and then render and measure the resulting visibleItems before calling setRowLength.");m(a)};this.setScrollPosition=function(a){n(a)};this.invalidateCache=function(){l(!0)};var h=e(function(){if(null===j())return k()?0:null;var a=Math.floor(n()/j()),c=b()-d(),a=a*m();return Math.min(c,a)}),d=e(function(){if(!q())return 0;if(null===g()||null===j())return k()?b()&&b()<k()?b():k():0;var a=
Math.ceil(g()/j())*m();return null!==b()&&b()<a?b():a});ko.extenders.notifyComparer=function(a,b){var c=ko.observable();c.equalityComparer=function(a,c){if(Array.isArray(a)){if(Array.isArray(c)){if(a.length!==c.length)return!1;for(var d=0;d<a.length;d++)if(!b(a[d],c[d]))return!1;return!0}return!1}return b(a,c)};a.subscribe(c);var d=!0;return ko.computed({deferEvaluation:!0,read:function(){d&&(d=!1,c(a.peek()));return c()}})};var f=ko.observableArray(),b=ko.observable(null),g=ko.observable(null),j=
ko.observable(null),n=ko.observable(0),m=ko.observable(1),k=ko.observable(null),q=ko.observable(!0),l=ko.observable(!1),p=null,r=null};
