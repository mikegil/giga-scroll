// GigaScroll
// version: 0.1.2
// author: Mattias Petter Johansson <mpj@mpj.me> http://mpj.me
// license: MIT
'use strict';function createNativeStringTemplateEngine(){var l=function(i){var c={},b=i;this.data=function(a,b){if(!b)return c[a];c[a]=b};this.text=function(a){if(!a)return b;b=a}},e={},b=new ko.nativeTemplateEngine;b.makeTemplateSource=function(b){return e[b]};b.addTemplate=function(b,c){e[b]=new l(c)};return b};(function(){ko.bindingHandlers.gigaScroll={init:function(l,e){var b=ko.utils.unwrapObservable(e()),i,c=l.innerHTML,g=createNativeStringTemplateEngine(),a="gigaScrollViewport"+Math.floor(1E6*Math.random()+1).toString(),h="gigaScrollList"+Math.floor(1E6*Math.random()+1).toString();g.addTemplate("gigaScroll",'    <div id="'+a+'" style="width: 100%; height: 100%; overflow-y: scroll; -webkit-transform:translateZ(0)">      <div data-bind="style: { height: riverHeight() + \'px\' }">        <div data-bind="style: { paddingTop: raftOffsetTop() + \'px\' }">          <ul id="'+
h+'" data-bind="foreach: renderItems">            '+c+"          </ul>        </div>      </div>    </div>");ko.renderTemplate("gigaScroll",b,{templateEngine:g},l,"replaceNode");c=document.getElementById(h);g=l.attributes;for(h=0;h<g.length;h++){var f=g[h];"data-bind"!==f.name&&c.setAttribute(f.name,f.value)}i=document.getElementById(a);b.setActive(!1);b.sample(7);var m=!1;b.renderItems.subscribe(function(a){if(a[a.length-1]&&!m){m=!0;var c,f=function(){for(var d,a=!1,b=e.peek(),j=g.getElementsByTagName("li"),
c=0;c<j.length;c++)d=j[c].offsetTop,b[c]!==d&&(b[c]=d,a=!0);a&&e.valueHasMutated()},a=function(){clearTimeout(h);h=setTimeout(f,16)},g=i.getElementsByTagName("UL")[0],h,e;e=ko.observableArray();g.addEventListener("DOMNodeInserted",a,!1);window.addEventListener("resize",a,!1);window.addEventListener("scroll",a,!1);a();c=e;i.addEventListener("scroll",function(){b.setScrollPosition(i.scrollTop)});a=function(){b.setViewPortHeight(i.offsetHeight)};window.addEventListener("resize",a,!1);a();var d=ko.computed({read:function(){var d=
[],a;for(a in j())d.push(parseInt(a));return d},deferEvaluation:!0}),j=ko.computed({read:function(){var d,a={};c().forEach(function(b){d=b.toString();a[d]=a[d]?a[d]+1:1});return 1===a.length?{}:a},deferEvaluation:!0});ko.computed(function(){var a=d();0!==a.length&&(a.sort(function(d,a){return d-a}),b.setRowHeight(a[1]-a[0]))});ko.computed(function(){var a,c;0!==j().length&&(d().forEach(function(d){c=j()[d.toString()];if(!a||c>a)a=c}),b.setRowLength(a))})}});return{controlsDescendantBindings:!0}}}})();function GigaScrollViewModel(l){function e(a){return ko.computed({read:a,deferEvaluation:!0}).extend({notifyComparer:b})}function b(a,b){return a===b}this.sample=function(a){k(a)};this.setActive=function(a){r(a)};this.renderItems=e(function(){var d,b;if(0===c()||null===i())return[];d=i()-c();d=Math.max(d,0);b=3*c();a:{for(var e=d,f=b;!p()&&g()[e];)e++,f--;for(;!p()&&g()[e+f-1]||null!==a()&&a()<=e+f-1;)if(1>f--)break a;clearTimeout(s);s=setTimeout(function(){l.load(e,f,function(d,b){var c=g.peek();
p()&&(c.length=0);for(var j=0;j<f;j++)c[e+j]=d[j];a(b);p(!1);g.valueHasMutated()})},250)}b=Array(c());for(d=0;d<c();d++)b[d]=g()[i()+d];return b});this.raftOffsetTop=e(function(){return Math.floor(i()/n())*f()});this.riverHeight=e(function(){return Math.floor(a()/n())*f()});this.setViewPortHeight=function(a){if(!k())throw Error("Call sample and then render and measure the resulting renderItems before calling setViewPortHeight.");h(a)};this.setRowHeight=function(a){if(!k())throw Error("Call sample and then render and measure the resulting renderItems before calling setRowHeight.");
clearTimeout(q);q=setTimeout(function(){var b=a-f();1===b||-1===b||f(a)},16)};this.setRowLength=function(a){if(!k())throw Error("Call sample and then render and measure the resulting renderItems before calling setRowLength.");n(a)};this.setScrollPosition=function(a){m(a)};this.invalidateCache=function(){p(!0)};var i=e(function(){if(null===f())return k()?0:null;var b=Math.floor(m()/f()),e=a()-c(),b=b*n();return Math.min(e,b)}),c=e(function(){if(!r())return 0;if(null===h()||null===f())return k()?a()&&
a()<k()?a():k():0;var b=Math.ceil(h()/f())*n();return null!==a()&&a()<b?a():b});ko.extenders.notifyComparer=function(a,b){var c=ko.observable();c.equalityComparer=function(a,c){if(Array.isArray(a)){if(Array.isArray(c)){if(a.length!==c.length)return!1;for(var d=0;d<a.length;d++)if(!b(a[d],c[d]))return!1;return!0}return!1}return b(a,c)};a.subscribe(c);var e=!0;return ko.computed({deferEvaluation:!0,read:function(){e&&(e=!1,c(a.peek()));return c()}})};var g=ko.observableArray(),a=ko.observable(null),
h=ko.observable(null),f=ko.observable(null),m=ko.observable(0),n=ko.observable(1),k=ko.observable(null),r=ko.observable(!0),p=ko.observable(!1),s=null,q=null};
