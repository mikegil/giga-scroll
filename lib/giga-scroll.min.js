// GigaScroll
// version: 0.1.4
// author: Mattias Petter Johansson <mpj@mpj.me> http://mpj.me
// license: MIT
'use strict';function createNativeStringTemplateEngine(){var f=function(a){var c={},b=a;this.data=function(a,b){if(!b)return c[a];c[a]=b};this.text=function(a){if(!a)return b;b=a}},d={},c=new ko.nativeTemplateEngine;c.makeTemplateSource=function(a){return d[a]};c.addTemplate=function(a,c){d[a]=new f(c)};return c};(function(){ko.bindingHandlers.gigaScroll={init:function(f,d){var c=ko.utils.unwrapObservable(d()),a,k=f.innerHTML,b=createNativeStringTemplateEngine(),m="gigaScrollViewport"+Math.floor(1E6*Math.random()+1).toString(),e="gigaScrollList"+Math.floor(1E6*Math.random()+1).toString();b.addTemplate("gigaScroll",'    <div id="'+m+'" style="width: 100%; height: 100%; overflow-y: scroll; -webkit-transform:translateZ(0)">      <div data-bind="style: { height: riverHeight() + \'px\' }">        <div data-bind="style: { paddingTop: raftOffsetTop() + \'px\' }">          <ul id="'+
e+'" data-bind="foreach: renderItems">            '+k+"          </ul>        </div>      </div>    </div>");ko.renderTemplate("gigaScroll",c,{templateEngine:b},f,"replaceNode");k=document.getElementById(e);b=f.attributes;for(e=0;e<b.length;e++){var q=b[e];"data-bind"!==q.name&&k.setAttribute(q.name,q.value)}a=document.getElementById(m);c.setActive(!1);c.sample(7);var n=!1;c.renderItems.subscribe(function(b){if(b[b.length-1]&&!n){n=!0;var d,k=function(){for(var a,b=!1,g=m.peek(),c=l.getElementsByTagName("li"),
d=0;d<c.length;d++){if(!ko.dataFor(c[d]))return;a=c[d].offsetTop;g[d]!==a&&(g[d]=a,b=!0)}b&&(l.removeEventListener("DOMNodeInserted",f,!1),m.valueHasMutated())},f=function(){clearTimeout(j);j=setTimeout(k,16)},l=a.getElementsByTagName("UL")[0],j,m;m=ko.observableArray();l.addEventListener("DOMNodeInserted",f,!1);window.addEventListener("resize",f,!1);f();d=m;a.addEventListener("scroll",function(){c.setScrollPosition(a.scrollTop)});b=function(){c.setViewPortHeight(a.offsetHeight)};window.addEventListener("resize",
b,!1);b();var e=ko.computed({read:function(){var a=[],b;for(b in p())a.push(parseInt(b));return a},deferEvaluation:!0}),p=ko.computed({read:function(){var a,b={};d().forEach(function(g){a=g.toString();b[a]=b[a]?b[a]+1:1});return 1===b.length?{}:b},deferEvaluation:!0});ko.computed(function(){var a=e();0!==a.length&&(a.sort(function(a,g){return a-g}),c.setRowHeight(a[1]-a[0]))});ko.computed(function(){var a,b;0!==p().length&&(e().forEach(function(g){b=p()[g.toString()];if(!a||b>a)a=b}),c.setRowLength(a))})}});
return{controlsDescendantBindings:!0}}}})();ko.extenders.notifyComparer=function(f,d){var c=ko.observable();c.equalityComparer=function(a,b){if(Array.isArray(a)){if(Array.isArray(b)){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(!d(a[c],b[c]))return!1;return!0}return!1}return d(a,b)};f.subscribe(c);var a=!0;return ko.computed({deferEvaluation:!0,read:function(){a&&(a=!1,c(f.peek()));return c()}})};
function GigaScrollViewModel(f){function d(a){return ko.computed({read:a,deferEvaluation:!0}).extend({notifyComparer:c})}function c(a,b){return a===b}var a=this;a.sample=function(a){j(a)};a.setActive=function(a){w(a)};a.renderItems=d(function(){var a,c;if(0===b()||null===k())return[];a=k()-b();a=Math.max(a,0);c=3*b();a:{for(var d=a,e=c;!r()&&n()[d];)d++,e--;for(;!r()&&n()[d+e-1]||null!==h()&&h()<=d+e-1;)if(1>e--)break a;clearTimeout(p);p=setTimeout(function(){f.load(d,e,function(a,b){var c=n.peek();
r()&&(c.length=0);for(var g=0;g<e;g++)c[d+g]=a[g];h(b);r(!1);n.valueHasMutated()})},250)}c=Array(b());for(a=0;a<b();a++)c[a]=n()[k()+a];return c});a.raftOffsetTop=d(function(){return null===l()||null===i()?0:k()/l()*i()});a.riverHeight=d(function(){return Math.floor(h()/l())*i()});a.setViewPortHeight=function(a){if(!j())throw Error("Call sample and then render and measure the resulting renderItems before calling setViewPortHeight.");u(a)};a.setRowHeight=function(a){if(!j())throw Error("Call sample and then render and measure the resulting renderItems before calling setRowHeight.");
clearTimeout(v);v=setTimeout(function(){var b=a-i();1===b||-1===b||i(a)},16)};a.setRowLength=function(a){if(!j())throw Error("Call sample and then render and measure the resulting renderItems before calling setRowLength.");l(a)};a.setScrollPosition=function(a){t(a)};a.invalidateCache=function(){r(!0)};a.setRowBuffer=function(a){s(a)};var k=d(function(){if(null===i())return j()?0:null;var a=h()-b(),c=Math.floor(e()/i())*l();return Math.max(0,Math.min(a,c))}),b=d(function(){if(!w())return 0;if(null===
i())return j()?h()&&h()<j()?h():j():0;var a=Math.ceil(m()/i())*l();return null!==h()&&h()<a?h():a}),m=d(function(){return Math.max(q()-e(),0)}),e=d(function(){return Math.max(0,t()-s()*i())}),q=d(function(){return Math.min(a.riverHeight(),t()+u()+s()*i())}),n=ko.observableArray(),h=ko.observable(null),u=ko.observable(null),i=ko.observable(null),t=ko.observable(0),l=ko.observable(1),j=ko.observable(null),w=ko.observable(!0),r=ko.observable(!1),p=null,v=null,s=ko.observable(0)};
