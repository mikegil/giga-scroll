// GigaScroll
// version: 0.0.8
// author: Mattias Petter Johansson <mpj@mpj.me> http://mpj.me
// license: MIT
'use strict';function createNativeStringTemplateEngine(){var k=function(b){var e={},c=b;this.data=function(b,c){if(!c)return e[b];e[b]=c};this.text=function(b){if(!b)return c;c=b}},h={},e=new ko.nativeTemplateEngine;e.makeTemplateSource=function(b){return h[b]};e.addTemplate=function(b,e){h[b]=new k(e)};return e};(function(){ko.bindingHandlers.gigaScroll={init:function(k,h){var e=ko.utils.unwrapObservable(h()),b,i=k.innerHTML,c=createNativeStringTemplateEngine(),g=Math.floor(1E5*Math.random()+1),j="gigaViewport"+g,g="gigaList"+g;c.addTemplate("gigaScroll",'    <div id="'+j+'" style="width: 100%; height: 100%; overflow-y: scroll">      <div class="gigaRiver" data-bind="style: { height: gigaDivHeight() + \'px\' }">        <div class="gigaRaft" data-bind="style: { paddingTop: offsetTop() + \'px\' }">          <ul id="'+
g+'" data-bind="foreach: visibleItems">            '+i+"          </ul>        </div>      </div>    </div>");ko.renderTemplate("gigaScroll",e,{templateEngine:c},k,"replaceNode");i=document.getElementById(g);c=k.attributes;for(g=0;g<c.length;g++){var d=c[g];"data-bind"!==d.name&&i.setAttribute(d.name,d.value)}b=document.getElementById(j);e.setActive(!1);e.sample(7);var m=!1;e.visibleItems.subscribe(function(c){c[c.length-1]&&!m&&(m=!0,setTimeout(function(){var c,d=function(){for(var a,b=!1,c=p.peek(),
e=g.getElementsByTagName("li"),d=0;d<e.length;d++)a=e[d].offsetTop,c[d]!==a&&(c[d]=a,b=!0);b&&p.valueHasMutated()},f=function(){clearTimeout(a);a=setTimeout(d,16)},g=b.getElementsByTagName("UL")[0],a,p;p=ko.observableArray();g.addEventListener("DOMNodeInserted",f,!1);window.addEventListener("resize",f,!1);window.addEventListener("scroll",f,!1);f();c=p;b.addEventListener("scroll",function(){e.setScrollPosition(b.scrollTop)});f=function(){e.setViewPortHeight(b.offsetHeight)};window.addEventListener("resize",
f,!1);f();var t=ko.computed({read:function(){var a=[],b;for(b in q())a.push(parseInt(b));return a},deferEvaluation:!0}),q=ko.computed({read:function(){var a,b={};c().forEach(function(c){a=c.toString();b[a]=b[a]?b[a]+1:1});return 1===b.length?{}:b},deferEvaluation:!0});ko.computed(function(){var a=t();0!==a.length&&(a.sort(function(a,b){return a-b}),e.setRowHeight(a[1]-a[0]))});ko.computed(function(){var a,b;0!==q().length&&(t().forEach(function(c){b=q()[c.toString()];if(!a||b>a)a=b}),e.setRowLength(a))})},
0))});return{controlsDescendantBindings:!0}}}})();function GigaScrollViewModel(k){function h(a){return ko.computed({read:a,deferEvaluation:!0}).extend({notifyComparer:k.equalityComparer||e})}function e(a,b){return a===b}ko.extenders.notifyComparer=function(a,b){var c=ko.observable();c.equalityComparer=function(a,c){var d;if(Array.isArray(a)){if(Array.isArray(c)){if(a.length!==c.length)return!1;for(d=0;d<a.length;d++)if(!b(a[d],c[d]))return!1;return!0}return!1}return b(a,c)};a.subscribe(c);var d=!0;return ko.computed({deferEvaluation:!0,read:function(){d&&
(d=!1,c(a.peek()));return c()}})};var b=this;b.sample=function(a){f(a)};b.setActive=function(a){s(a)};b.visibleItems=h(function(){var a,b;if(!s()||null===i()||null===c)return[];a=i()-c();a=Math.max(a,0);b=3*c();a:{for(var e=a,f=b;j()[e];)e++,f--;for(;j()[e+f-1]||null!==d()&&d()<=e+f-1;)if(f--,1>f)break a;clearTimeout(g);g=setTimeout(function(){k.load(e,f,function(a,b){for(var c=0;c<f;c++)j()[e+c]=a[c];d(b);j.valueHasMutated()})},250)}b=Array(c());for(a=0;a<c();a++)b[a]=j()[i()+a];return b});b.offsetTop=
h(function(){return Math.floor(i()/n())*l()});b.gigaDivHeight=h(function(){return Math.floor(d()/n())*l()});b.setViewPortHeight=function(a){if(!f())throw Error("Call sample and then render and measure the resulting visibleItems before calling setViewPortHeight.");m(a)};b.setRowHeight=function(a){if(!f())throw Error("Call sample and then render and measure the resulting visibleItems before calling setRowHeight.");clearTimeout(b.setRowLengthPositionHandle);b.setRowLengthPositionHandle=setTimeout(function(){l(a)},
16)};b.setRowLength=function(a){if(!f())throw Error("Call sample and then render and measure the resulting visibleItems before calling setRowLength.");n(a)};b.setScrollPosition=function(a){r(a)};var i=h(function(){if(null===l())return f()?0:null;var a=Math.floor(r()/l()),b=d()-c(),a=a*n();return Math.min(b,a)}),c=h(function(){if(null===m()||null===l())return f()&&d()&&d()<f()?d():f();var a=Math.ceil(m()/l())*n();return null!==d()&&d()<a?d():a}),g=null,j=ko.observableArray(),d=ko.observable(null),
m=ko.observable(null),l=ko.observable(null),r=ko.observable(0),n=ko.observable(1),f=ko.observable(null),s=ko.observable(!0)};
